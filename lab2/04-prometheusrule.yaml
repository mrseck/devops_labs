apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: postgres-pvc-alerts
  namespace: random-db
  labels:
    app: postgresql
    component: monitoring
    lab: lab2
    prometheus: default
spec:
  groups:
    - name: postgres_pvc_alerts
      interval: 30s
      rules:
        - alert: PVCUsageWarning
          expr: |
            pvc_usage_percent{
              namespace="random-db"
            } > 70
          for: 5m
          labels:
            severity: warning
            component: storage
            namespace: random-db
            alertname: PVCUsageWarning
          annotations:
            summary: "PVC PostgreSQL √† 70% de capacit√©"
            description: |
              Le PVC de PostgreSQL dans le namespace {{ $labels.namespace }} 
              est utilis√© √† {{ $value | printf "%.2f" }}% de sa capacit√©.
              Espace utilis√©: {{ with query "pvc_used_bytes{namespace='" }}{{ . | first | value | humanize1024 }}B{{ end }}
              Capacit√© totale: {{ with query "pvc_capacity_bytes{namespace='" }}{{ . | first | value | humanize1024 }}B{{ end }}
            runbook_url: "https://wiki.example.com/runbook/pvc-warning"
            dashboard_url: "https://grafana.example.com/d/pvc-monitoring"
        
        - alert: PVCUsageCritical
          expr: |
            pvc_usage_percent{
              namespace="random-db"
            } > 85
          for: 2m
          labels:
            severity: critical
            component: storage
            namespace: random-db
            alertname: PVCUsageCritical
          annotations:
            summary: "PVC PostgreSQL √† 85% - Action urgente requise"
            description: |
              ‚ö†Ô∏è CRITIQUE: Le PVC de PostgreSQL dans le namespace {{ $labels.namespace }} 
              est utilis√© √† {{ $value | printf "%.2f" }}% de sa capacit√©.
              Action imm√©diate requise pour √©viter une saturation.
              
              Espace utilis√©: {{ with query "pvc_used_bytes{namespace='" }}{{ . | first | value | humanize1024 }}B{{ end }}
              Capacit√© totale: {{ with query "pvc_capacity_bytes{namespace='" }}{{ . | first | value | humanize1024 }}B{{ end }}
              
              Actions recommand√©es:
              - √âtendre le PVC imm√©diatement
              - Nettoyer les anciennes sauvegardes
              - V√©rifier les logs pour identifier la cause
            runbook_url: "https://wiki.example.com/runbook/pvc-critical"
            dashboard_url: "https://grafana.example.com/d/pvc-monitoring"
        
        - alert: PVCUsageEmergency
          expr: |
            pvc_usage_percent{
              namespace="random-db"
            } > 95
          for: 1m
          labels:
            severity: emergency
            component: storage
            namespace: random-db
            alertname: PVCUsageEmergency
          annotations:
            summary: "PVC PostgreSQL √† 95% - Risque imminent d'interruption"
            description: |
              üö® URGENCE: Le PVC de PostgreSQL dans le namespace {{ $labels.namespace }} 
              est utilis√© √† {{ $value | printf "%.2f" }}% de sa capacit√©.
              
              Espace utilis√©: {{ with query "pvc_used_bytes{namespace='" }}{{ . | first | value | humanize1024 }}B{{ end }}
              Capacit√© totale: {{ with query "pvc_capacity_bytes{namespace='" }}{{ . | first | value | humanize1024 }}B{{ end }}
              
              ‚ö†Ô∏è RISQUE IMMINENT D'INTERRUPTION DES SERVICES ‚ö†Ô∏è
              
              Actions IMM√âDIATES:
              1. √âtendre le PVC en urgence (kubectl patch pvc)
              2. Activer le mode read-only sur PostgreSQL
              3. Supprimer les donn√©es non critiques
              4. Escalader vers l'√©quipe d'infrastructure
            runbook_url: "https://wiki.example.com/runbook/pvc-emergency"
            dashboard_url: "https://grafana.example.com/d/pvc-monitoring"
        
        - alert: PVCGrowthRate
          expr: |
            (
              predict_linear(
                pvc_used_bytes{
                  namespace="random-db"
                }[7d], 
                7 * 24 * 3600
              ) > 
              pvc_capacity_bytes{
                namespace="random-db"
              }
            ) and (
              pvc_usage_percent{
                namespace="random-db"
              } > 50
            )
          for: 1h
          labels:
            severity: warning
            component: storage
            namespace: random-db
            alertname: PVCGrowthRate
          annotations:
            summary: "Projection de saturation du PVC PostgreSQL dans moins de 7 jours"
            description: |
              üìä Analyse pr√©dictive: Bas√© sur le taux de croissance des 7 derniers jours, 
              le PVC de PostgreSQL dans le namespace {{ $labels.namespace }} 
              devrait atteindre sa capacit√© maximale dans moins de 7 jours.
              
              Utilisation actuelle: {{ with query "pvc_used_bytes{namespace='" }}{{ . | first | value | humanize1024 }}B{{ end }} ({{ with query "pvc_usage_percent{namespace='" }}{{ . | first | value | printf "%.2f" }}%{{ end }})
              Capacit√© totale: {{ with query "pvc_capacity_bytes{namespace='" }}{{ . | first | value | humanize1024 }}B{{ end }}
              
              Actions recommand√©es:
              - Planifier l'extension du PVC
              - Auditer la croissance des donn√©es
              - Mettre en place une politique de r√©tention
            runbook_url: "https://wiki.example.com/runbook/pvc-growth-rate"
            dashboard_url: "https://grafana.example.com/d/pvc-monitoring"